import time
import getproxy
import json,requests,urllib.request
from traceback import print_exc
from ast import literal_eval
import pprint

def push_to_git():
    #Import dependencies
    from subprocess import call
    #Commit Message
    commit_message = "Updating json files"
    #Stage the file
    call('git add .', shell = True)
    # Add your commit
    call('git commit -m "'+ commit_message +'"', shell = True)
    #Push the new or update files
    call('git push origin master', shell = True)

def get_proxy():
    proxies=[]
    proxy= ["117.242.147.181:51266", "123.176.43.218:40524", "103.87.47.41:8080", "139.59.70.215:80", "103.69.220.14:3128", "45.115.171.30:47949", "103.21.163.76:6666", "103.46.233.16:81", "103.15.60.21:8080", "103.46.232.129:83", "103.250.153.199:43369", "125.21.43.122:8080", "45.248.65.34:8080", "103.69.220.14:3128", "103.88.127.209:34927", "45.115.171.30:47949", "103.250.153.199:43369", "103.255.234.81:39847", "103.240.161.108:6666", "103.21.163.76:6666", "103.250.166.17:6666", "203.192.195.14:31062", "117.196.232.154:8080", "45.116.106.98:8080", "103.79.164.49:53281", "43.224.182.140:40779", "43.224.180.202:30933", "45.248.65.34:8080", "103.14.232.22:8080", "103.87.48.131:8888", "103.198.172.4:50820", "103.250.166.17:6666", "103.47.153.87:8080", "203.192.195.14:31062", "103.240.161.108:6666", "116.197.152.198:61568", "103.240.161.59:48809", "43.224.182.140:40779", "117.196.232.154:8080", "103.117.23.164:33343", "103.14.232.22:8080", "125.21.43.122:8080", "116.197.152.198:61568", "103.47.93.194:51618", "163.53.87.22:8080", "43.224.180.202:30933", "45.116.106.98:8080", "103.56.30.128:8080", "103.79.164.49:53281", "103.54.28.26:61774", "103.51.26.233:30867", "103.216.175.4:50031", "103.198.172.4:50820", "103.240.161.59:48809", "103.49.54.1:83", "45.115.175.112:41093", "103.42.195.70:53281", "103.51.26.233:30867", "103.49.53.1:83", "103.69.220.13:8080", "125.17.113.26:8080", "103.87.104.137:8080", "163.53.87.22:8080", "103.41.96.46:53281", "103.70.145.106:51851", "103.98.79.42:46525", "106.0.37.10:80", "114.69.229.161:8080", "103.117.23.164:33343", "103.54.28.26:61774", "103.87.48.131:8888", "103.42.195.70:53281", "103.98.79.42:46525", "103.240.161.107:60288", "103.69.220.13:8080", "14.102.67.101:30337", "103.87.104.137:8080", "103.41.96.46:53281", "103.255.235.129:39847", "103.225.30.1:53281", "103.70.145.106:51851", "106.0.37.10:80", "114.69.229.161:8080", "103.240.161.107:60288", "49.249.251.86:53281", "43.241.28.201:8080", "43.225.23.26:8080", "202.62.84.210:53281", "43.240.5.41:31777", "49.249.251.86:53281", "45.113.66.81:53738", "45.121.29.254:54858", "43.225.23.26:8080", "45.121.29.254:54858", "45.113.66.81:53738", "103.70.205.241:44424", "103.87.47.27:53281", "103.87.47.27:53281", "103.228.76.46:58703", "103.240.160.21:6666", "103.65.193.249:55417", "103.70.146.250:59563", "103.25.47.130:8080", "103.100.168.1:8080", "103.48.70.193:8080", "103.228.76.46:58703", "103.46.233.15:83", "103.70.146.250:59563", "103.218.102.22:8080", "103.65.193.249:55417", "103.211.76.5:8080", "103.240.160.21:6666", "103.218.102.22:8080", "103.100.168.1:8080", "103.69.220.11:3128", "103.46.233.15:83", "103.46.235.1:81", "103.211.76.5:8080", "117.244.15.243:3128", "117.211.166.214:3128", "117.244.15.243:3128", "139.5.26.28:8080", "139.5.26.28:8080", "119.161.99.25:83", "123.108.200.34:83", "125.62.198.97:83", "103.216.95.16:61755", "103.199.157.130:40052", "103.224.5.5:54143", "103.42.89.49:53281", "117.240.151.237:39376", "103.14.235.109:8080", "103.65.193.17:50862", "103.224.5.5:54143", "103.72.217.173:48766", "103.42.89.69:53281", "103.216.172.1:50031", "103.92.117.129:33891", "103.212.129.65:52390", "103.21.163.70:6666", "117.240.151.237:39376", "103.42.89.49:53281", "116.197.152.65:61568", "106.0.37.10:8080", "1.186.63.130:39142", "103.205.112.129:23500", "103.21.163.70:6666", "103.42.89.69:53281", "103.65.193.17:50862", "103.92.117.129:33891", "183.82.116.56:8080", "125.62.213.134:84", "1.186.63.130:39142", "182.75.110.122:58290", "103.72.217.173:48766", "14.143.30.202:23500", "125.62.193.21:83", "183.82.116.56:8080", "125.62.213.134:84", "182.75.110.122:58290", "116.197.152.65:61568", "125.62.193.21:83", "182.18.177.114:56173", "45.112.57.230:61222", "223.196.83.182:53281", "43.240.5.1:31777", "43.248.73.86:53281", "43.240.5.225:31777", "27.116.51.115:8080", "45.112.57.230:61222", "27.116.51.115:8080", "223.196.83.182:53281", "43.240.5.225:31777", "43.248.73.86:53281", "43.225.192.241:50878", "43.240.5.1:31777", "43.225.192.241:50878"]
    i=0
    while(i!=100):
        for p in proxy:
            try:
                user_agent = {'User-agent': 'Mozilla/5.0'}
                url = 'http://pubproxy.com/api/proxy?country=IN&limit=20&https=True&user_agent=true'
                try:
                    resp = requests.get(url=url,headers=user_agent,proxies={"http": p, "https": p})
                    print(str(i)+'th attempt successful')
                except Exception as e:
                    print(e.__class__.__name__)
                    print_exc()
                    print('Failed '+str(i)+' time')
                finally:
                    i=i+1
                data = resp.json()
                time.sleep(2.1)
                for proxy in data['data']:
                    proxies.append(proxy['ipPort'])
                    print('Length of Proxy till now is ',len(proxies))
            except Exception :
                break

    try:
        print("Entered Spy proxy")
        proxies=proxies+spy_proxy()
    except Exception :
        pass

    try:
        proxies=proxies+fate_proxy()
    except Exception:
        pass

    return proxies

def fate_proxy():
    resp=requests.get('https://raw.githubusercontent.com/fate0/proxylist/master/proxy.list')
    a=((resp.text).split('\n'))
    p_list=[]
    for i in a:
        try:
            p_list.append(json.loads(i))
        except Exception as e:
            continue
    np_list=[]
    for i in p_list:
        if i['country']=='IN':
            np_list.append(i)
    #print(len(np_list))
    proxy=[]
    for i in np_list:
        proxy.append((str(i['host'])+':'+str(i['port'])))
    return(proxy)

def spy_proxy():
    resp=requests.get('http://spys.me/proxy.txt')
    data=((resp.text).split("Google_passed(+)")[1]).split('\r')[0]
    data=data.split('\n')
    l=[]
    for i in data:
        if 'IN' in i:
            i=i.split(' IN')[0]
            l.append(i)
    return l


proxy_json={'data':get_proxy()}
import json
with open('proxy.json', 'w') as outfile:
    json.dump(proxy_json, outfile)
push_to_git()
